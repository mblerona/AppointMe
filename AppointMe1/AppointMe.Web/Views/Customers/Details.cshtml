@model AppointMe.Domain.DTO.CustomerProfileDTO
@using Microsoft.AspNetCore.Identity
@using AppointMe.Domain.Identity
@using AppointMe.Repository.Data
@inject UserManager<AppointMeAppUser> UserManager
@inject ApplicationDbContext Db

@{
    ViewData["Title"] = "Customer Details";

  
    var enableServices = false;
    if (User?.Identity?.IsAuthenticated == true)
    {
        var u = await UserManager.GetUserAsync(User);
        if (u?.TenantId != null && u.TenantId != Guid.Empty)
        {
            var biz = await Db.Businesses.FindAsync(u.TenantId.Value);
            enableServices = biz?.EnableServices == true;
        }
    }

    decimal CalcTotal(AppointMe.Domain.DTO.AppointmentDTO a)
    {
        if (a.Services == null || !a.Services.Any()) return 0m;
        return a.Services.Sum(x => x.PriceAtBooking);
    }
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<style>
    .page-wrap {
        max-width: 1100px;
        margin: 0 auto;
    }

    .card-soft {
        border: 1px solid rgba(0,0,0,.06);
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0,0,0,.06);
        background: #fff;
    }

    .section-title {
        font-size: .95rem;
        letter-spacing: .02em;
        text-transform: uppercase;
        color: #6c757d;
    }

    .table-rounded {
        border-radius: 16px;
        overflow: hidden;
        border: 1px solid #dee2e6;
        background: #fff;
    }


    .btn, .form-control, .form-select {
        border-radius: 12px;
    }

    .info-row {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        padding: 8px 0;
    }

    .info-ic {
        width: 22px;
        text-align: center;
        color: #6c757d;
        margin-top: 2px;
    }

    .info-label {
        width: 110px;
        color: #6c757d;
        font-weight: 600;
    }

    .info-val {
        flex: 1;
        font-weight: 600;
        color: #212529;
        word-break: break-word;
    }

    .muted-val {
        font-weight: 500;
        color: #6c757d;
    }

    .badge-soft {
        background: rgba(13,110,253,.12);
        color: #0d6efd;
        border: 1px solid rgba(13,110,253,.18);
        border-radius: 999px;
        padding: 6px 10px;
        font-weight: 700;
    }

    .table thead th {
        font-size: .85rem;
        letter-spacing: .02em;
        text-transform: uppercase;
        color: #6c757d;
        border-top: 0;
    }

    .table td {
        vertical-align: middle;
    }

    .total-cell {
        text-align: right;
        font-weight: 800;
    }

    .empty-state {
        border: 1px dashed rgba(0,0,0,.15);
        border-radius: 14px;
        padding: 18px;
        background: rgba(0,0,0,.02);
    }
</style>

<div class="page-wrap py-4">

    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <div class="d-flex align-items-center gap-2">
            <div>
                <div class="section-title mb-1">Customer</div>
                <h2 class="mb-0 fw-bold">@Model.FirstName @Model.LastName</h2>
            </div>
            <span class="badge-soft mt-4">#@Model.CustomerNumber</span>
        </div>

        <div class="d-flex gap-2">
            <a class="btn btn-outline-warning" asp-action="Edit" asp-route-id="@Model.Id">
                <i class="bi bi-pencil"></i> Edit
            </a>
            <a class="btn btn-outline-secondary" asp-action="Index">
                <i class="bi bi-arrow-left"></i> Back
            </a>
        </div>
    </div>

    <div class="row g-3">
        <!-- LEFT -->
        <div class="col-lg-5">

            <!-- CONTACT CARD -->
            <div class="card card-soft">
                <div class="card-body">

                    <div class="d-flex align-items-center mb-3">
                        <i class="bi bi-person-lines-fill fs-4 me-2 text-primary"></i>
                        <div>
                            <div class="section-title">Contact Information</div>
                           
                        </div>
                    </div>

                    <div class="info-row">
                        <div class="info-ic"><i class="bi bi-envelope"></i></div>
                        <div class="info-label">Email</div>
                        <div class="info-val">
                            @if (!string.IsNullOrWhiteSpace(Model.Email))
                            {
                                <a href="mailto:@Model.Email" class="text-decoration-none">@Model.Email</a>
                            }
                            else
                            {
                                <span class="muted-val">—</span>
                            }
                        </div>
                    </div>

                    <div class="info-row">
                        <div class="info-ic"><i class="bi bi-telephone"></i></div>
                        <div class="info-label">Phone</div>
                        <div class="info-val">
                            @if (!string.IsNullOrWhiteSpace(Model.PhoneNumber))
                            {
                                <a href="tel:@Model.PhoneNumber" class="text-decoration-none">@Model.PhoneNumber</a>
                            }
                            else
                            {
                                <span class="muted-val">—</span>
                            }
                        </div>
                    </div>

                    <div class="info-row">
                        <div class="info-ic"><i class="bi bi-telephone-forward"></i></div>
                        <div class="info-label">Second</div>
                        <div class="info-val">
                            @if (!string.IsNullOrWhiteSpace(Model.SecondPhoneNumber))
                            {
                                <a href="tel:@Model.SecondPhoneNumber" class="text-decoration-none">@Model.SecondPhoneNumber</a>
                            }
                            else
                            {
                                <span class="muted-val">—</span>
                            }
                        </div>
                    </div>

                    <hr class="my-3" />

                    <div class="info-row">
                        <div class="info-ic"><i class="bi bi-geo-alt"></i></div>
                        <div class="info-label">Location</div>
                        <div class="info-val">
                            @if (!string.IsNullOrWhiteSpace(Model.City) || !string.IsNullOrWhiteSpace(Model.State))
                            {
                                <span>@Model.City</span>
                                @if (!string.IsNullOrWhiteSpace(Model.City) && !string.IsNullOrWhiteSpace(Model.State))
                                {
                                    <span>, </span>
                                }
                                <span>@Model.State</span>
                            }
                            else
                            {
                                <span class="muted-val">—</span>
                            }
                        </div>
                    </div>

                    <div class="info-row">
                        <div class="info-ic"><i class="bi bi-journal-text"></i></div>
                        <div class="info-label">Notes</div>
                        <div class="info-val">
                            @if (!string.IsNullOrWhiteSpace(Model.Notes))
                            {
                                <span class="fw-normal">@Model.Notes</span>
                            }
                            else
                            {
                                <span class="muted-val">—</span>
                            }
                        </div>
                    </div>

                    <hr class="my-3" />

                    <div class="small text-muted d-flex justify-content-between">
                        <div><i class="bi bi-clock"></i> Created: @Model.CreatedAt.ToString("dd MMM yyyy")</div>
                        <div>Updated: @Model.UpdatedAt.ToString("dd MMM yyyy")</div>
                    </div>

                </div>
            </div>

            <!-- STATS -->
            <div class="card card-soft mt-3">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <i class="bi bi-bar-chart-line fs-4 me-2 text-primary"></i>
                        <div>
                            <div class="section-title">Appointment statidtics</div>
                          
                        </div>
                    </div>

                    <div class="row text-center g-2">
                        <div class="col-6">
                            <div class="fw-bold fs-4">@Model.TotalAppointments</div>
                            <small class="text-muted">Total</small>
                        </div>
                        <div class="col-6">
                            <div class="fw-bold fs-4">@Model.ScheduledAppointments</div>
                            <small class="text-muted">Scheduled</small>
                        </div>
                        <div class="col-6">
                            <div class="fw-bold fs-4">@Model.CompletedAppointments</div>
                            <small class="text-muted">Completed</small>
                        </div>
                        <div class="col-6">
                            <div class="fw-bold fs-4">@Model.CancelledAppointments</div>
                            <small class="text-muted">Cancelled</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-3">
                <a class="btn btn-primary w-100"
                   asp-controller="Appointments"
                   asp-action="Create"
                   asp-route-customerId="@Model.Id">
                    <i class="bi bi-plus-circle"></i> New Appointment
                </a>
            </div>

        </div>

        <!-- RIGHT -->
        <div class="col-lg-7">
            <div class="card card-soft">
                <div class="card-body">

                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <div>
                            <div class="section-title">Customer Appointmnets</div>
                           
                        </div>
                    </div>

                    @if (Model.Appointments == null || !Model.Appointments.Any())
                    {
                        <div class="empty-state text-center">
                            <div class="fw-bold mb-1">No appointments yet</div>
                            <div class="text-muted small mb-3">Create the first appointment for this customer.</div>
                            <a class="btn btn-primary"
                               asp-controller="Appointments"
                               asp-action="Create"
                               asp-route-customerId="@Model.Id">
                                <i class="bi bi-plus-circle"></i> New Appointment
                            </a>
                        </div>
                    }
                    else
                    {
                        <div class="table-responsive table-rounded">
                            <table class="table table-hover align-middle mb-0 border-1 table-bordered text-center ">
                                <thead class="">
                                    <tr class="">
                                        <th class="bg-primary text-light" style="width: 170px;">Date</th>
                                        <th class="bg-primary text-light"  style="width: 90px;">Time</th>
                                        <th class="bg-primary text-light" >Order Number</th>

                                        @if (enableServices)
                                        {
                                            <th class="text-end bg-primary text-light" style="width: 140px;">Total</th>
                                        }

                                        <th class="bg-primary text-light" style="width: 120px; ">Status</th>
                                        <th class="bg-primary text-light"  style="width: 120px;"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var a in Model.Appointments)
                                    {
                                        var computedTotal = CalcTotal(a);
                                        var hasServices = a.Services != null && a.Services.Any();

                                        <tr>
                                            <td class="fw-semibold">@a.AppointmentDate.ToString("MMM dd, yyyy")</td>
                                            <td class="text-muted fw-semibold">@a.AppointmentDate.ToString("HH:mm")</td>
                                            <td class="fw-semibold">@a.OrderNumber</td>

                                            @if (enableServices)
                                            {
                                                <td class="total-cell">
                                                    @if (hasServices)
                                                    {
                                                        @($"{computedTotal:0.00} ден")
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">—</span>
                                                    }
                                                </td>
                                            }

                                            <td>@a.Status</td>

                                            <td class="text-center">
                                                <a class="btn btn-sm btn-outline-primary"
                                                   asp-controller="Appointments"
                                                   asp-action="Details"
                                                   asp-route-id="@a.Id">
                                                    Open
                                                </a>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }

                </div>
            </div>
        </div>

    </div>
</div>

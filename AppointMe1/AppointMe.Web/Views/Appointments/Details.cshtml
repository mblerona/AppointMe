@model AppointMe.Domain.DTO.AppointmentDTO
@using Microsoft.AspNetCore.Identity
@using AppointMe.Domain.Identity
@using AppointMe.Repository.Data
@inject UserManager<AppointMeAppUser> UserManager
@inject ApplicationDbContext Db

@{
    ViewData["Title"] = "Appointment Details";

    string StatusBadgeClass(string? status)
    {
        var s = (status ?? "").Trim().ToLowerInvariant();
        return s switch
        {
            "scheduled" => "badge rounded-pill text-bg-primary",
            "completed" => "badge rounded-pill text-bg-success",
            "cancelled" => "badge rounded-pill text-bg-danger",
            "noshow" => "badge rounded-pill text-bg-warning",
            _ => "badge rounded-pill text-bg-secondary"
        };
    }

    string StatusPillClass(string? status)
    {
        var s = (status ?? "").Trim().ToLowerInvariant();
        return s switch
        {
            "scheduled" => "status-pill status-scheduled",
            "completed" => "status-pill status-completed",
            "cancelled" => "status-pill status-cancelled",
            "noshow" => "status-pill status-noshow",
            _ => "status-pill"
        };
    }

    string StatusIcon(string? status)
    {
        var s = (status ?? "").Trim().ToLowerInvariant();
        return s switch
        {
            "scheduled" => "bi-calendar-check",
            "completed" => "bi-check2-circle",
            "cancelled" => "bi-x-circle",
            "noshow" => "bi-exclamation-circle",
            _ => "bi-info-circle"
        };
    }

    bool IsActive(string? current, string target)
        => (current ?? "").Equals(target, StringComparison.OrdinalIgnoreCase);

    var returnUrl = $"{Context.Request.Path}{Context.Request.QueryString}";

 
    var enableServices = false;
    var enableInvoices = false;

    if (User?.Identity?.IsAuthenticated == true)
    {
        var u = await UserManager.GetUserAsync(User);
        if (u?.TenantId != null && u.TenantId != Guid.Empty)
        {
            var biz = await Db.Businesses.FindAsync(u.TenantId.Value);
            enableServices = biz?.EnableServices == true;

           
            enableInvoices = enableServices && biz?.EnableInvoices == true;
        }
    }

   
    var hasServices = Model.Services != null && Model.Services.Any();

   
    var canInvoice = enableInvoices && hasServices;

   
    var safeDescription = string.IsNullOrWhiteSpace(Model.Description) ? "—" : Model.Description;
    var safeCustomer = string.IsNullOrWhiteSpace(Model.CustomerName) ? "—" : Model.CustomerName;

 
    var dDay = Model.AppointmentDate.ToString("dd");
    var dMon = Model.AppointmentDate.ToString("MMM");
    var dDow = Model.AppointmentDate.ToString("dddd");
    var tFull = Model.AppointmentDate.ToString("HH:mm");
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<style>
    .details-wrap {
        max-width: 980px;
        margin: 0 auto;
    }

    .card-soft {
        border: 1px solid rgba(0,0,0,.06);
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0,0,0,.06);
        background: #fff;
    }

    .kpi {
        border: 1px solid rgba(0,0,0,.06);
        border-radius: 16px;
        background: #fff;
        box-shadow: 0 10px 30px rgba(0,0,0,.04);
    }

    .btn-xxs {
        padding: 4px 10px;
        font-size: .75rem;
        line-height: 1;
        border-radius: 999px;
        font-weight: 700;
    }

    .section-title {
        font-size: .95rem;
        letter-spacing: .02em;
        text-transform: uppercase;
        color: #6c757d;
    }

    .muted {
        color: #6c757d;
    }

    .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px;
    }

    .info-item {
        border: 1px solid rgba(0,0,0,.06);
        border-radius: 14px;
        padding: 12px 14px;
        background: rgba(108,117,125,.06);
    }

    .info-label {
        font-size: .78rem;
        letter-spacing: .02em;
        text-transform: uppercase;
        color: #6c757d;
        font-weight: 700;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .info-value {
        font-weight: 800;
        color: #212529;
        word-break: break-word;
    }

        .info-value code {
            font-weight: 800;
            background: rgba(0,0,0,.06);
            padding: 2px 8px;
            border-radius: 999px;
        }

    .date-badge {
        width: 64px;
        min-width: 64px;
        border-radius: 16px;
        border: 1px solid rgba(0,0,0,.06);
        background: rgba(13,110,253,.08);
        padding: 10px 0;
        text-align: center;
        line-height: 1.05;
    }

        .date-badge .day {
            font-size: 1.2rem;
            font-weight: 900;
        }

        .date-badge .mon {
            font-size: .78rem;
            font-weight: 800;
            text-transform: uppercase;
            color: #6c757d;
        }

    .when-row {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 14px;
        border-radius: 16px;
        border: 1px solid rgba(0,0,0,.06);
        background: #fff;
    }

    .when-meta .dow {
        font-weight: 900;
    }

    .when-meta .sub {
        font-weight: 700;
        color: #6c757d;
        font-size: .9rem;
    }

    .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 999px;
        font-weight: 900;
        font-size: .85rem;
        border: 1px solid rgba(0,0,0,.06);
        background: rgba(108,117,125,.10);
        color: #495057;
        white-space: nowrap;
    }

    .status-scheduled {
        background: rgba(13,110,253,.12);
        border-color: rgba(13,110,253,.18);
        color: #0d6efd;
    }

    .status-completed {
        background: rgba(25,135,84,.12);
        border-color: rgba(25,135,84,.18);
        color: #198754;
    }

    .status-cancelled {
        background: rgba(220,53,69,.12);
        border-color: rgba(220,53,69,.18);
        color: #dc3545;
    }

    .status-noshow {
        background: rgba(255,193,7,.18);
        border-color: rgba(255,193,7,.22);
        color: #a07400;
    }

    .svc-list {
        list-style: none;
        padding-left: 0;
        margin-bottom: 0;
    }

    .svc-item {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
        padding: 10px 0;
        border-bottom: 1px dashed rgba(0,0,0,.12);
    }

        .svc-item:last-child {
            border-bottom: none;
        }

    .svc-name {
        font-weight: 800;
    }

    .svc-cat {
        font-size: .85rem;
        color: #6c757d;
        font-weight: 600;
    }

    .price-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(0,0,0,.06);
        background: rgba(108,117,125,.08);
        font-weight: 900;
        white-space: nowrap;
    }

    .total-row {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid rgba(0,0,0,.08);
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 900;
    }

    .desc-box {
        border: 1px solid rgba(0,0,0,.06);
        border-radius: 16px;
        background: #fff;
        padding: 12px 14px;
    }

    .desc-title {
        font-size: .78rem;
        letter-spacing: .02em;
        text-transform: uppercase;
        color: #6c757d;
        font-weight: 800;
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .desc-text {
        font-weight: 600;
        margin: 0;
    }

    .meta-foot {
        margin-top: 14px;
        font-size: .9rem;
        color: #6c757d;
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 8px;
    }
</style>

<div class="details-wrap py-4">

    <!-- Header -->
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
        <div>
            <div class="section-title mb-1">Appointment Details</div>
            <h2 class="mb-0 fw-bold">
                Appointment for: @safeCustomer
                <span class="ms-2 @StatusBadgeClass(Model.Status)">@Model.Status</span>
            </h2>
        </div>

        <div class="d-flex gap-2">
            <a class="btn btn-outline-warning" asp-action="Edit" asp-route-id="@Model.Id">
                <i class="bi bi-pencil"></i> Edit
            </a>
            <a class="btn btn-outline-secondary" asp-action="Index">
                <i class="bi bi-arrow-left"></i> Back
            </a>
        </div>
    </div>

    <div class="row g-3">
        <!-- Left -->
        <div class="col-12 col-lg-8">
            <div class="card card-soft">
                <div class="card-body">

                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <div class="section-title">Information</div>
                            <div class="fw-bold">Overview</div>
                        </div>
                        <span class="text-muted small">
                            Updated: @Model.UpdatedAt.ToString("dd MMM yyyy")
                        </span>
                    </div>
                    <hr />
                    <!-- WHEN block -->
                    <div class="when-row mb-3 flex-column align-items-start">

                        <!-- ROW 1: LABEL -->
                        <div class="info-label mb-2">
                            <i class="bi bi-calendar-event"></i>
                            Date and Time
                        </div>

                        <!-- ROW 2: DATE + TIME CONTENT -->
                        <div class="d-flex align-items-center gap-3">
                            <div class="date-badge">
                                <div class="day">@dDay</div>
                                <div class="mon">@dMon</div>
                            </div>

                            <div class="when-meta">
                                <div class="dow">@dDow</div>
                                <div class="sub">
                                    <i class="bi bi-clock"></i> @tFull
                                    <span class="mx-2">•</span>
                                    <i class="bi bi-calendar3"></i> @Model.AppointmentDate.ToString("yyyy")
                                </div>
                            </div>
                        </div>

                    </div>


                    <!-- MAIN INFO -->
                    <div class="info-grid mb-3">
                        <div class="info-item">
                            <div class="info-label"><i class="bi bi-person"></i> Customer</div>
                            <div class="info-value">@safeCustomer</div>
                        </div>

                         <div class="info-item">
                            <div class="info-label"><i class="bi bi-receipt"></i> Order Number</div>
                            <div class="info-value"><code>@Model.OrderNumber</code></div>
                        </div> 
                    </div>

                    <!-- DESCRIPTION -->
                    <div class="desc-box">
                        <div class="desc-title"><i class="bi bi-card-text"></i> Description</div>
                        <p class="desc-text">@safeDescription</p>
                    </div>

                    <br /><br />
                    <hr />
                    <!-- SERVICES -->
                    @if (enableServices)
                    {
                        <div class="mb-3">
                            <div class="section-title mb-2">Services</div>

                            @if (hasServices)
                            {
                                <ul class="svc-list">
                                    @foreach (var s in Model.Services)
                                    {
                                        <li class="svc-item">
                                            <div>
                                                <div class="svc-name">@s.Name</div>
                                                @if (!string.IsNullOrWhiteSpace(s.Category))
                                                {
                                                    <div class="svc-cat"><i class="bi bi-tag"></i> @s.Category</div>
                                                }
                                            </div>
                                            <span class="price-chip">
                                                <i class="bi bi-cash-coin text-muted"></i>
                                                @s.PriceAtBooking.ToString("0.00") ден
                                            </span>
                                        </li>
                                    }
                                </ul>

                                <div class="total-row">
                                    <span>Total</span>
                                    <span>@Model.TotalPrice.ToString("0.00") ден</span>
                                </div>
                            }
                            else
                            {
                                <div class="desc-box">
                                    <div class="desc-title"><i class="bi bi-info-circle"></i> Services</div>
                                    <p class="desc-text text-muted mb-0">No services selected.</p>
                                </div>
                            }
                        </div>
                    }

                    <div class="meta-foot">
                        <div><i class="bi bi-clock"></i> Created: @Model.CreatedAt.ToString("dd MMM yyyy")</div>
                        <div><i class="bi bi-pencil-square"></i> Updated: @Model.UpdatedAt.ToString("dd MMM yyyy")</div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Right -->
        <div class="col-12 col-lg-4">
            <div class="kpi p-3">
                <div class="section-title mb-2">Change Status</div>

                <div class="d-flex flex-wrap gap-2">
                    @foreach (var s in new[] { "Scheduled", "Completed", "Cancelled", "NoShow" })
                    {
                        var active = IsActive(Model.Status, s);

                        <form asp-action="SetStatus" method="post" class="d-inline">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@Model.Id" />
                            <input type="hidden" name="status" value="@s" />
                            <input type="hidden" name="returnUrl" value="@returnUrl" />

                            <button type="submit"
                                    class="btn btn-xxs @(active ? "btn-primary" : "btn-outline-dark")"
                            @(active ? "disabled" : null)>
                                @s
                            </button>
                        </form>
                    }
                </div>

                <hr class="my-3" />

                <div class="section-title mb-2">Quick Actions</div>

                <div class="d-grid gap-2">
                    <a class="btn btn-outline-primary"
                       asp-controller="Customers"
                       asp-action="Details"
                       asp-route-id="@Model.CustomerId">
                        <i class="bi bi-person"></i> View Customer
                    </a>

                    @* Invoice only if services on *@
                    @if (canInvoice)
                    {
                        <form asp-controller="Invoices" asp-action="CreateFromAppointment" method="post">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="appointmentId" value="@Model.Id" />
                            <button type="submit" class="btn btn-outline-dark w-100">
                                <i class="bi bi-receipt"></i> Invoice
                            </button>
                        </form>
                    }
                    else if (enableServices && enableInvoices && !hasServices)
                    {
                        <div class="alert alert-light border mb-0">
                            <div class="small text-muted">
                                <i class="bi bi-info-circle"></i>
                                Add at least one service to generate an invoice.
                            </div>
                        </div>
                    }

                    <a class="btn btn-outline-danger"
                       asp-action="Delete"
                       asp-route-id="@Model.Id">
                        <i class="bi bi-trash"></i> Delete Appointment
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

@model IEnumerable<AppointMe.Domain.DTO.AppointmentDTO>
@using AppointMe.Domain.DomainModels
@using Microsoft.AspNetCore.Identity
@using AppointMe.Domain.Identity
@using AppointMe.Repository.Data
@inject UserManager<AppointMeAppUser> UserManager
@inject ApplicationDbContext Db

@{
    ViewData["Title"] = "Appointments";


    var enableServices = false;
    if (User?.Identity?.IsAuthenticated == true)
    {
        var u = await UserManager.GetUserAsync(User);
        if (u?.TenantId != null && u.TenantId != Guid.Empty)
        {
            var biz = await Db.Businesses.FindAsync(u.TenantId.Value);
            enableServices = biz?.EnableServices == true;
        }
    }
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<style>
    .btn-pill {
        height: 38px;
        width: 38px;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        color: gray;
    }
    .btn-xxs {
        padding: 4px 6px;
        font-size: 0.75rem;
        line-height: 1;
        border-radius: 8px;
    }

        .btn-xxs i {
            font-size: 0.9rem;
        }

    /* Card-like table rows */
    .table-card {
        border-collapse: separate;
        border-spacing: 0 10px; /* space between rows */
    }

        .table-card tbody tr {
            background: #fff;
            box-shadow: 0 8px 20px rgba(0,0,0,.05);
            border-radius: 14px;
            transition: transform .15s ease, box-shadow .15s ease;
        }

            .table-card tbody tr:hover {
                transform: translateY(-1px);
                box-shadow: 0 12px 28px rgba(0,0,0,.08);
            }

        .table-card td {
            padding: 14px 16px;
            border-top: none;
        }

            .table-card td:first-child {
                border-top-left-radius: 14px;
                border-bottom-left-radius: 14px;
            }

            .table-card td:last-child {
                border-top-right-radius: 14px;
                border-bottom-right-radius: 14px;
            }

    .muted {
        color: #6c757d;
        font-size: .85rem;
    }

    /* Small badge for status */
    .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        font-weight: 700;
        font-size: .78rem;
        border: 1px solid rgba(0,0,0,.06);
        background: rgba(108,117,125,.10);
        color: #495057;
        white-space: nowrap;
    }

    .status-scheduled {
        background: rgba(13,110,253,.12);
        border-color: rgba(13,110,253,.18);
        color: #0d6efd;
    }

    .status-completed {
        background: rgba(25,135,84,.12);
        border-color: rgba(25,135,84,.18);
        color: #198754;
    }

    .status-cancelled {
        background: rgba(220,53,69,.12);
        border-color: rgba(220,53,69,.18);
        color: #dc3545;
    }

    .status-noshow {
        background: rgba(255,193,7,.18);
        border-color: rgba(255,193,7,.22);
        color: #a07400;
    }
</style>

@functions {
    string StatusClass(string? status)
    {
        var s = (status ?? "").Trim().ToLowerInvariant();
        return s switch
        {
            "scheduled" => "status-pill status-scheduled",
            "completed" => "status-pill status-completed",
            "cancelled" => "status-pill status-cancelled",
            "noshow" => "status-pill status-noshow",
            _ => "status-pill"
        };
    }
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Appointments</h2>
    <div class="d-flex gap-2">
        <a class="btn btn-outline-secondary" asp-action="Calendar">
            <i class="bi bi-calendar3"></i> Calendar
        </a>
        <a class="btn btn-primary" asp-action="Create">
            <i class="bi bi-plus-circle"></i> New Appointment
        </a>
    </div>
</div>


<br /><br />

<form method="get" class="row g-2 mb-3">
    <div class="col-md-3">
        <select class="form-select " name="status" style=" border-radius: 999px;">
            <option value="">-- Filter by status --</option>
            @foreach (var s in Enum.GetNames(typeof(AppointmentStatus)))
            {
                <option value="@s" selected="@(ViewData["Status"]?.ToString() == s)">
                    @s
                </option>
            }
        </select>
    </div>
    <div class="col-md-3">
      
        <input type="date" class="form-control" name="startDate" value="@ViewData["StartDate"]" style=" border-radius: 999px;s" />
    </div>
 @*    <div class="col-md-3">
        <input type="date" class="form-control" name="endDate" value="@ViewData["EndDate"]" />
    </div> *@
    <div class="col-md-3 d-flex gap-2">
       @*  <button class="btn btn-outline-secondary w-100" type="submit">Apply</button>
        <a class="btn btn-outline-dark w-100" asp-action="Index">Clear</a> *@

        <button class="btn btn-outline-primary btn-pill"
                type="submit"
                title="title">
            <i class="bi bi-arrow-right"></i>
        </button>

        <a class="btn btn-outline-danger btn-pill"
           asp-action="Index"
           title="Clear">
            <i class="bi bi-x"></i>
        </a>
    </div>

</form>
<br /><br />

<table class="table table-hover align-middle table-card text-center table-bordered">
    <thead class="text-muted small table-bordered">
        <tr class="text-center table-bordered">
            <th>Date & Time</th>
            <th>Customer</th>
            <th>Order #</th>
            @if (enableServices)
            {
                <th>Total</th>
            }
            <th>Status</th>
            <th style="width:220px;">Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var a in Model)
        {
            <tr>
                <td>
                    <div class="fw-semibold">@a.AppointmentDate.ToString("MMM dd, yyyy")</div>
                    <div class="muted fw-semibold">@a.AppointmentDate.ToString("HH:mm")</div>
                </td>

                <td>
                    <div class="fw-semibold">
                        @(string.IsNullOrWhiteSpace(a.CustomerName) ? "-" : a.CustomerName)
                    </div>
                </td>

                <td>
                    <div class="fw-semibold">@a.OrderNumber</div>
                    <div class="muted"># Order</div>
                </td>

                @if (enableServices)
                {
                    <td class="fw-semibold">
                        @(a.Services != null && a.Services.Any()
                            ? a.TotalPrice.ToString("0.00") + " ден"
                            : "—")
                    </td>
                }

                <td>
                    <span class="@StatusClass(a.Status)">
                        <i class="bi bi-circle-fill" style="font-size:.5rem;"></i>
                        @a.Status
                    </span>
                </td>

                <td class="text-end">
                    <div class="d-inline-flex gap-1">
                        <a class="btn btn-xxs btn-outline-primary"
                           asp-action="Details"
                           asp-route-id="@a.Id"
                           title="Details">
                            <i class="bi bi-eye"></i>
                        </a>

                        <a class="btn btn-xxs btn-outline-warning"
                           asp-action="Edit"
                           asp-route-id="@a.Id"
                           title="Edit">
                            <i class="bi bi-pencil"></i>
                        </a>

                        <a class="btn btn-xxs btn-outline-danger"
                           asp-action="Delete"
                           asp-route-id="@a.Id"
                           title="Delete">
                            <i class="bi bi-trash"></i>
                        </a>
                    </div>
                </td>
            </tr>
        }
    </tbody>
</table>

@if (!Model.Any())
{
    <div class="alert alert-info mt-3">No appointments found.</div>
}

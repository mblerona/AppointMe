@using Microsoft.AspNetCore.Identity
@using AppointMe.Domain.Identity
@using AppointMe.Repository.Data
@using AppointMe.Domain.DomainModels
@inject SignInManager<AppointMeAppUser> SignInManager
@inject UserManager<AppointMeAppUser> UserManager
@inject ApplicationDbContext Db

@functions {
    bool IsLightColor(string hex)
    {
        if (string.IsNullOrWhiteSpace(hex)) return false;
        hex = hex.Replace("#", "");
        if (hex.Length != 6) return false;

        var r = Convert.ToInt32(hex.Substring(0, 2), 16);
        var g = Convert.ToInt32(hex.Substring(2, 2), 16);
        var b = Convert.ToInt32(hex.Substring(4, 2), 16);

        var brightness = (r * 299 + g * 587 + b * 114) / 1000;
        return brightness > 160;
    }

    string ActiveClass(string controller, string? action = null)
    {
        var currentController = ViewContext.RouteData.Values["controller"]?.ToString() ?? "";
        var currentAction = ViewContext.RouteData.Values["action"]?.ToString() ?? "";

        var okController = currentController.Equals(controller, StringComparison.OrdinalIgnoreCase);
        var okAction = action == null || currentAction.Equals(action, StringComparison.OrdinalIgnoreCase);

        return (okController && okAction) ? "active" : "";
    }
}

@{
    Business? biz = null;

    if (User?.Identity?.IsAuthenticated == true)
    {
        var u = await UserManager.GetUserAsync(User);
        if (u?.TenantId != null && u.TenantId != Guid.Empty)
        {
            biz = await Db.Businesses.FindAsync(u.TenantId.Value);
        }
    }

    var navbarColor = biz?.PrimaryColor ?? "#212529";
    var bgColor = biz?.SecondaryColor ?? "#ffffff";
    var hasTenant = biz != null;

    var isLightNavbar = IsLightColor(navbarColor);
    var navTextColor = isLightNavbar ? "#000000" : "#ffffff";

    // pill background + border adapt to navbar brightness
    var pillBg = isLightNavbar ? "rgba(0,0,0,.08)" : "rgba(255,255,255,.14)";
    var pillBorder = isLightNavbar ? "rgba(0,0,0,.12)" : "rgba(255,255,255,.22)";
    var pillActiveBg = isLightNavbar ? "rgba(0,0,0,.18)" : "rgba(255,255,255,.22)";
    var pillHoverBg = isLightNavbar ? "rgba(0,0,0,.12)" : "rgba(255,255,255,.18)";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - AppointMe</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        :root {
            --biz-navbar: @navbarColor;
            --biz-bg: @bgColor;
            --biz-nav-text: @navTextColor;

            --pill-bg: @pillBg;
            --pill-border: @pillBorder;
            --pill-active-bg: @pillActiveBg;
            --pill-hover-bg: @pillHoverBg;
        }

        body {
            background-color: var(--biz-bg) !important;
        }

        /* Top bar */
        .topbar {
            background-color: var(--biz-navbar);
            color: var(--biz-nav-text);
        }

        .topbar a,
        .topbar .nav-link,
        .topbar .navbar-brand {
            color: var(--biz-nav-text) !important;
        }

        .brand {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            letter-spacing: .2px;
            text-decoration: none;
        }

        .brand img {
            height: 28px;
            width: auto;
            border-radius: 8px;
            background: rgba(255,255,255,.9);
            padding: 2px;
        }

        /* Pill nav like your example */
        .pill-nav {
            display: inline-flex;
            gap: 6px;
            padding: 6px;
            border-radius: 999px;
            background: var(--pill-bg);
            border: 1px solid var(--pill-border);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .pill-nav .nav-link {
            border-radius: 999px;
            padding: 8px 14px;
            font-weight: 600;
            opacity: .92;
        }

        .pill-nav .nav-link:hover {
            background: var(--pill-hover-bg);
            opacity: 1;
        }

        .pill-nav .nav-link.active {
            background: var(--pill-active-bg);
            border: 1px solid var(--pill-border);
            opacity: 1;
        }

        /* Right side icon buttons */
        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--pill-border);
            background: var(--pill-bg);
            color: var(--biz-nav-text) !important;
            text-decoration: none;
        }

        .icon-btn:hover {
            background: var(--pill-hover-bg);
        }

        /* Toggler icon (Bootstrap default is black; this makes it visible on dark) */
        .navbar-toggler {
            border-color: var(--pill-border);
        }

        .navbar-toggler-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba(255,255,255,0.9)' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
        }

        /* If navbar is light, use dark toggler icon */
        @if (isLightNavbar)
        {
        <text>
        .navbar-toggler-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba(0,0,0,0.75)' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
        }
        </text>
        }

        @@media (max-width: 992px) {
            .pill-nav {
                width: 100%;
                justify-content: space-between;
                overflow-x: auto;
                white-space: nowrap;
            }
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg topbar py-3">
        <div class="container">

            <!-- Brand -->
            <a class="brand navbar-brand" asp-controller="Dashboard" asp-action="Index">
                @if (!string.IsNullOrWhiteSpace(biz?.LogoUrl))
                {
                    <img src="@biz.LogoUrl" alt="Logo" />
                }
                <span>@(biz?.Name ?? "AppointMe")</span>
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="nav">

                <!-- Center pill navigation -->
                <div class="mx-lg-auto my-3 my-lg-0">
                    @if (User.Identity?.IsAuthenticated == true && hasTenant)
                    {
                        <ul class="navbar-nav pill-nav">
                            <li class="nav-item">
                                <a class="nav-link @ActiveClass("Dashboard","Index")" asp-controller="Dashboard" asp-action="Index">
                                    Dashboard
                                </a>
                            </li>

                            <li class="nav-item">
                                <a class="nav-link @ActiveClass("Customers","Index")" asp-controller="Customers" asp-action="Index">
                                    Customers
                                </a>
                            </li>

                            <li class="nav-item">
                                <a class="nav-link @ActiveClass("Appointments","Index")" asp-controller="Appointments" asp-action="Index">
                                    Appointments
                                </a>
                            </li>

                            

                            @if (biz?.EnableServices == true)
                            {
                                <li class="nav-item">
                                    <a class="nav-link @ActiveClass("Services","Index")" asp-controller="Services" asp-action="Index">
                                        Services
                                    </a>
                                </li>
                            }
                            <li class="nav-item">
                                <a class="nav-link @ActiveClass("Appointments","Calendar")" asp-controller="Appointments" asp-action="Calendar">
                                    Calendar
                                </a>
                            </li>
                        </ul>
                    }
                </div>

                <!-- Right side actions -->
                <div class="ms-lg-auto d-flex align-items-center gap-2">

                    @if (User.Identity?.IsAuthenticated == true)
                    {
                        <a class="icon-btn" asp-controller="Settings" asp-action="Business" title="Settings">
                            <i class="bi bi-gear"></i>
                        </a>
                    }

                    @if (SignInManager.IsSignedIn(User))
                    {
                        <form asp-area="Identity" asp-page="/Account/Logout" method="post" class="d-inline">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="icon-btn" title="Logout">
                                <i class="bi bi-box-arrow-right"></i>
                            </button>
                        </form>
                    }
                </div>

            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <partial name="_Toast" />
        @RenderBody()
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    @RenderSection("Scripts", required: false)
</body>
</html>
